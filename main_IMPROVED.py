#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üöÄ IMPROVED SOLUTION - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–µ—Ç–æ–∫—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è J=0.7+

–¶–µ–ª—å: STA=0.88+, SIM=0.93+, FL=0.93+ ‚Üí J=0.76+

–ü–æ–¥—Ö–æ–¥:
1. –†–ê–°–®–ò–†–ï–ù–ù–´–ô —Å–ª–æ–≤–∞—Ä—å —Ç–æ–∫—Å–∏—á–Ω—ã—Ö —Å–ª–æ–≤ (–≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ)
2. GPT-4o —Å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
3. –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: –ø—Ä–∞–≤–∏–ª–∞ + GPT –¥–ª—è –≤—Å–µ–≥–æ
"""

import re
import os
import pandas as pd
from openai import OpenAI
from tqdm import tqdm
import time
from functools import lru_cache

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
API_KEY = os.getenv("OPENAI_API_KEY", "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")
MODEL_NAME = "gpt-4o-2024-11-20"
MAX_RETRIES = 3
RETRY_DELAY = 2

client = OpenAI(api_key=API_KEY)

INPUT_FILE = "dev_inputs.tsv"
OUTPUT_FILE = "submission.tsv"

total_input_tokens = 0
total_output_tokens = 0
total_api_calls = 0

# ================================
# –†–ê–°–®–ò–†–ï–ù–ù–´–ô –°–õ–û–í–ê–†–¨ –¢–û–ö–°–ò–ß–ù–û–°–¢–ò
# ================================

TOXIC_PATTERNS = [
    # –†—É—Å—Å–∫–∏–µ –º–∞—Ç—ã (–≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
    (r'\b[–±–ë]–ª—è[–¥—è–µ—é–∏—å—Ç—å]?\w*', ''),
    (r'\b[–±–ë]–ª[–µ—ç–∏][–Ω—Ç]\w*', ''),
    (r'\b[—Ö–•]—É–π\w*', ''),
    (r'\b[—Ö–•][—É–£][–π–ô–∏–ò–µ–ï—è–Ø]\w*', ''),  # —Ö—É–π–Ω—è –∏ —Ç–¥
    (r'\b[—Ö–•]–µ—Ä\w*', ''),
    (r'\b[—Ö–•]—É–ª–∏\w*', ''),
    (r'\b[–∂–ñ]–æ–ø\w*', ''),
    (r'\b[–Ω–ù]–∞—Ö—É–π\w*', ''),
    (r'\b[–Ω–ù]–∞—Ö\b', ''),
    (r'\b[–µ–ï]–±\w+', ''),
    (r'\b[–∑–ó]–∞–µ–±\w+', ''),
    (r'\b[—Å–°]—É–∫–∞\w*', ''),
    (r'\b[–ø–ü]–∏–∑–¥\w+', ''),
    (r'\b[—Ö–•]—Ä–µ–Ω\w*', ''),

    # –¢–∞—Ç–∞—Ä—Å–∫–∏–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è (–†–ê–°–®–ò–†–ï–ù–ù–´–ô)
    (r'\b[–∫–ö][—É“Ø–£“Æ][—Ç–¢][–∞-—è”ô”©“Ø“£“ì“õ“ª—ë—ä—åA-Z”ò”®“Æ“¢“í“ö“∫.\-]*', ''),  # –∫—É—Ç*, –∫—É—Ç–∞–∫, –∫—É—Ç–µ–Ω, –∫—É—Ç–ª–∞–∫
    (r'\b[–∞–ê][—Ö–•]–º–∞–∫\w*', ''),
    (r'\b[–∞–ê]–Ω–≥—ã—Ä–∞\w*', ''),
    (r'\b[—Ç–¢]–∏–Ω—Ç[”ô—ç]–∫\w*', ''),
    (r'\b[—Ö–•]–∞–π–≤–∞–Ω\w*', ''),
    (r'\b[—Ç–¢]–∏–ª–µ[–ª–∫]?\w*', ''),
    (r'\b[–º–ú]–∞—Ä[–∂“ó]–∞\w*', ''),
    (r'\b[—á–ß]—É—á–∫–∞\w*', ''),
    (r'\b[—Ç–¢]–æ?–º–æ—Ä–æ–∑\w*', ''),
    (r'\b[–æ–û]—è—Ç—Å—ã–∑\w*', ''),
    (r'\b[—Å–°]–≤–æ–ª–æ—á—å\w*', ''),
    (r'\b[–¥–î]—É—Ä–∞–∫\w*', ''),
    (r'\b[–∏–ò]–¥–∏–æ—Ç\w*', ''),
    (r'\b[–¥–î]–µ–±–∏–ª\w*', ''),
    (r'\b[—Ç–¢]–≤–∞—Ä[—å—ä]?\w*', ''),

    # –ù–û–í–´–ï (–ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ)
    (r'\b[—Å–°]–æ—Å–æ[–ø–º]\w*', ''),  # —Å–æ—Å–æ–ø, —Å–æ—Å–æ–º
    (r'\b[–∑–ó]–∞–∏–ø–∞\w*', ''),  # –∑–∞–∏–ø–∞–ª–∏, –∑–∞–∏–ø–∞–ª
    (r'\b[–∑–ó]–∞–π–ø\w*', ''),  # –∑–∞–π–ø–∞–ª–∏
]

# –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ñ—Ä–∞–∑—ã
PHRASES = [
    (r'–Ω–∞\s+–∂–æ–ø\w*', ''),
    (r'–≤\s+–∂–æ–ø\w*', ''),
    (r'[–∫–ö]—É—Ç–ª–∞–∫\s+–∫–µ–±–µ–∫', '–£–ª –∫–µ–±–µ–∫'),  # –í–∞–∂–Ω–æ: –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∑–∞–º–µ–Ω–∞
    (r'–æ—á–µ–Ω\s+[–∫–ö][—É“Ø][—Ç–¢]\w*\s+–∂—ã—Ä—Ç\w*', '–æ—á–µ–Ω –∂—ã—Ä—Ç'),
    (r'[—É“Ø]–∑\s+[–∫–ö][—É“Ø][—Ç–¢]\w*', '—É–∑'),  # —É–∑ –∫—É—Ç–µ–Ω—ç ‚Üí —É–∑
]


def rule_based_detox(text):
    """–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏"""
    if not isinstance(text, str):
        return text

    result = text

    # @user
    result = re.sub(r'@\w+[,\s]*', '', result)

    # –§—Ä–∞–∑—ã (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
    for pattern, repl in PHRASES:
        result = re.sub(pattern, repl, result, flags=re.IGNORECASE)

    # –°–ª–æ–≤–∞
    for pattern, repl in TOXIC_PATTERNS:
        result = re.sub(pattern, repl, result, flags=re.IGNORECASE)

    # –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤
    result = re.sub(r'  +', ' ', result)
    result = re.sub(r'\s+([,!?.;:])', r'\1', result)
    result = result.strip()

    return result if len(result) > 2 else text


# ================================
# GPT –î–ï–¢–û–ö–°–ò–§–ò–ö–ê–¶–ò–Ø
# ================================

@lru_cache(maxsize=2000)
def gpt_detox(text: str) -> str:
    """
    GPT-4o –¥–ª—è –ø–æ–ª–Ω–æ–π –¥–µ—Ç–æ–∫—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

    –í—ã–∑—ã–≤–∞–µ–º –¥–ª—è –í–°–ï–• —Ç–µ–∫—Å—Ç–æ–≤ (–Ω–µ —Ç–æ–ª—å–∫–æ —Å –±—ã—Å—Ç—Ä—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏)
    """

    prompt = f"""–î–µ—Ç–æ–∫—Å–∏—Ñ–∏—Ü–∏—Ä—É–π —Ç–∞—Ç–∞—Ä—Å–∫–∏–π —Ç–µ–∫—Å—Ç. –£–¥–∞–ª–∏ –í–°–ï —Ç–æ–∫—Å–∏—á–Ω—ã–µ —Å–ª–æ–≤–∞, —Å–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É.

üéØ –¶–ï–õ–¨: J = STA √ó SIM √ó FL ‚Üí MAX
- STA (–¥–µ—Ç–æ–∫—Å–∏—Ñ–∏–∫–∞—Ü–∏—è): –ü–û–õ–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ –æ—Ç —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏
- SIM (—Å—Ö–æ–∂–µ—Å—Ç—å): –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (~94%)
- FL (–≥—Ä–∞–º–º–∞—Ç–∏–∫–∞): –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç

üìã –ü–†–ê–í–ò–õ–ê:
1. –£–¥–∞–ª—è–π –í–°–ï –º–∞—Ç—ã –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è (—Ä—É—Å—Å–∫–∏–µ –∏ —Ç–∞—Ç–∞—Ä—Å–∫–∏–µ):
   - –†—É—Å—Å–∫–∏–µ: –±–ª—è*, —Ö—É–π*, –∂–æ–ø*, –µ–±–∞—Ç—å*, —Å—É–∫–∞*, –ø–∏–∑–¥*, —Ö–µ—Ä—ä*, –±–ª–∏–Ω (–∫–∞–∫ —ç–≤—Ñ–µ–º–∏–∑–º)
   - –¢–∞—Ç–∞—Ä—Å–∫–∏–µ: –∫—É—Ç*, –∞—Ö–º–∞–∫*, –∞–Ω–≥—ã—Ä–∞*, —Ç–∏–Ω—Ç—ç–∫*, —Ö–∞–π–≤–∞–Ω*, —Ç–∏–ª–µ*, —á—É—á–∫–∞*, —Å–æ—Å–æ–ø*, –∑–∞–∏–ø–∞*

2. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∑–∞–º–µ–Ω—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–º—ã—Å–ª–∞:
   - "–∫—É—Ç–µ–Ω" (–µ–≥–æ –∑–∞–¥–Ω–∏—Ü–∞) ‚Üí "–∞–Ω—ã" (–µ–≥–æ) –∏–ª–∏ —É–±—Ä–∞—Ç—å
   - "–∫—É—Ç–ª–∞–∫ –∫–µ–±–µ–∫" (–∫–∞–∫ –∂–æ–ø–∞) ‚Üí "—É–ª –∫–µ–±–µ–∫" (–∫–∞–∫ –æ–Ω/–æ–Ω–∞)
   - "–æ—á–µ–Ω –∫—É—Ç –∂—ã—Ä—Ç–∞" ‚Üí "–æ—á–µ–Ω –∂—ã—Ä—Ç–∞" –∏–ª–∏ "–æ—á–µ–Ω —Å—É–≥—ã—à–∞"
   - "—É–∑ –∫—É—Ç–µ–Ω—ç" ‚Üí "—É–∑–µ–Ω—ç" (—Å–µ–±–µ)
   - "–∫—É—Ç–∞–∫ —Å—ã—Ä–ª–∞–º–∞" ‚Üí "—Å—ã—Ä–ª–∞–º–∞"

3. –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –æ–±—Ä—É–±–∫–∏:
   - –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–µ–ø–æ–ª–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –¥–æ–±–∞–≤—å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
   - –ù–µ –æ—Å—Ç–∞–≤–ª—è–π –ø—Ä–µ–¥–ª–æ–≥–∏ –≤ –∫–æ–Ω—Ü–µ

4. –ù–ï –º–µ–Ω—è–π:
   - –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ —Å—Ç–∏–ª—å
   - –°–º–∞–π–ª–∏–∫–∏, —ç–º–æ–¥–∑–∏
   - –ü–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)

5. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –¥–µ—Ç–æ–∫—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –ë–ï–ó –ø–æ—è—Å–Ω–µ–Ω–∏–π

‚úÖ –ü–†–ò–ú–ï–†–´:

–í—Ö–æ–¥: –∞–ª–¥—ã–π–º –∏–Ω–¥–µ –º–∏–Ω!)) –º–∏–Ω–µ–∫–µ –±–ª–∏–Ω –π–æ—Ä—Ç—Ç–∞–Ω –¥–∞ —á—ã–∫–º—ã–π, –æ–π–¥—ç –≥—ç–Ω—ç —Å–æ—Å–æ–ø —è—Ç–∞ =D
–í—ã—Ö–æ–¥: –∞–ª–¥—ã–π–º –∏–Ω–¥–µ –º–∏–Ω!)) –º–∏–Ω–µ–∫–µ –π–æ—Ä—Ç—Ç–∞–Ω –¥–∞ —á—ã–∫–º—ã–π, –æ–π–¥—ç –≥—ç–Ω—ç —è—Ç–∞ =D

–í—Ö–æ–¥: –ö—É—Ç–ª–∞–∫ –∫–µ–±–µ–∫ —É—Ä—ã—Å –∞—Å—Ç—ã–Ω–∞ —è—Ç–∫–∞–Ω!
–í—ã—Ö–æ–¥: –£–ª –∫–µ–±–µ–∫ —É—Ä—ã—Å –∞—Å—Ç—ã–Ω–∞ —è—Ç–∫–∞–Ω!

–í—Ö–æ–¥: —É—Ñ –±–ª—è.—Å–µ–∫—Ç–µ–≥–µ–∑ —É–∂–µ.—à—É–Ω–¥—ã–π –∫—É—Ç–∞–∫ –±–∞—à —á—Ç–æ–ª–∏ —Ç—ã?—Å–∞–º–∞ —Ä–µ—à–∞–π!
–í—ã—Ö–æ–¥: —É—Ñ. —Å–µ–∫—Ç–µ–≥–µ–∑ —É–∂–µ. —à—É–Ω–¥—ã–π –±–∞—à —á—Ç–æ–ª–∏ —Ç—ã? —Å–∞–º–∞ —Ä–µ—à–∞–π!

–í—Ö–æ–¥: @user, —Å–∏–Ω –∫–∏–ª –¥–∞–≤–∞–π, –∫—É—Ç–∞–∫ —Å—ã—Ä–ª–∞–º–∞!
–í—ã—Ö–æ–¥: —Å–∏–Ω –∫–∏–ª –¥–∞–≤–∞–π, —Å—ã—Ä–ª–∞–º–∞!

–í—Ö–æ–¥: –£–∑ –∫—É—Ç–µ–Ω—ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ —ç–∑–ª—ç–≥—ç–Ω—Å–µ–Ω –∏–Ω–¥–µ –±—É–ª–¥—ã—Ä–≥–∞–Ω—Å—ã–Ω!!
–í—ã—Ö–æ–¥: –£–∑–µ–Ω—ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ —ç–∑–ª—ç–≥—ç–Ω—Å–µ–Ω –∏–Ω–¥–µ –±—É–ª–¥—ã—Ä–≥–∞–Ω—Å—ã–Ω!!

–í—Ö–æ–¥: –ü–∞—Ç—Ä–∏–æ—Ç–∏–∑–º? –•—ç—Ö, –º–∏–Ω —Ç–∞—Ç–∞—Ä, –±—ç–ª–∫–∏ —Å–∏–Ω —É—Ä—ã—Å—Ç—ã—Ä, —É—Ä—ã—Å –æ—á–µ–Ω –∫—É—Ç –∂—ã—Ä—Ç—ã–ø, –ø–∞—Ç—Ä–∏–æ—Ç –±—É–ª—ã–ø —è—à–∏ –∞–ª–º—ã–π–º
–í—ã—Ö–æ–¥: –ü–∞—Ç—Ä–∏–æ—Ç–∏–∑–º? –•—ç—Ö, –º–∏–Ω —Ç–∞—Ç–∞—Ä, –±—ç–ª–∫–∏ —Å–∏–Ω —É—Ä—ã—Å—Ç—ã—Ä, —É—Ä—ã—Å –æ—á–µ–Ω —Å—É–≥—ã—à—ã–ø, –ø–∞—Ç—Ä–∏–æ—Ç –±—É–ª—ã–ø —è—à–∏ –∞–ª–º—ã–π–º

–í—Ö–æ–¥: –ó–∞–∏–ø–∞–ª–∏ –±–ª–∏–Ω, –Ω—ç—Ä—Å—ç –±—É–ª—ç–∫ –∏—Ç–∏–º, –Ω–∏—à–ª–∏–º –¥–∏–µ–ø!
–í—ã—Ö–æ–¥: –ù—ç—Ä—Å—ç –±—É–ª—ç–∫ –∏—Ç–∏–º, –Ω–∏—à–ª–∏–º –¥–∏–µ–ø!

–¢–ï–ö–°–¢:
{text}

–†–ï–ó–£–õ–¨–¢–ê–¢:"""

    global total_input_tokens, total_output_tokens, total_api_calls

    for attempt in range(MAX_RETRIES):
        try:
            resp = client.chat.completions.create(
                model=MODEL_NAME,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.1,  # –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                max_tokens=250,
                top_p=0.85,
                seed=42
            )

            if hasattr(resp, 'usage') and resp.usage:
                total_input_tokens += resp.usage.prompt_tokens
                total_output_tokens += resp.usage.completion_tokens
                total_api_calls += 1

            result = resp.choices[0].message.content.strip()

            # –û—á–∏—Å—Ç–∫–∞
            if "–í—ã—Ö–æ–¥:" in result or "–†–ï–ó–£–õ–¨–¢–ê–¢:" in result or "–í—Ö–æ–¥:" in result:
                lines = result.split('\n')
                for line in lines:
                    if line and not any(x in line for x in ['–í—Ö–æ–¥:', '–í—ã—Ö–æ–¥:', '–†–ï–ó–£–õ–¨–¢–ê–¢:']):
                        result = line.strip()
                        break

            result = result.strip('"\'`')

            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if len(result) < len(text) * 0.35:  # –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
                return text

            if len(result) > len(text) * 1.4:  # –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
                return text

            return result if result else text

        except Exception as e:
            if attempt < MAX_RETRIES - 1:
                time.sleep(RETRY_DELAY)
            else:
                print(f"‚ö†Ô∏è  API error: {e}")
                return text

    return text


def hybrid_detox(text):
    """
    –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –¥–µ—Ç–æ–∫—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:
    1. –ü—Ä–∞–≤–∏–ª–∞ (–±—ã—Å—Ç—Ä–æ)
    2. GPT (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ)
    """
    # Step 1: –ü—Ä–µ–¥–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏
    cleaned = rule_based_detox(text)

    # Step 2: GPT –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –¥–µ—Ç–æ–∫—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    # –í—ã–∑—ã–≤–∞–µ–º –í–°–ï–ì–î–ê, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ —É–∂–µ –æ—á–∏—Å—Ç–∏–ª–∏
    final = gpt_detox(cleaned)

    return final


def main():
    print("="*70)
    print("üöÄ IMPROVED SOLUTION - Aggressive Detoxification")
    print("="*70)

    print(f"\nüì• Reading: {INPUT_FILE}")
    df = pd.read_csv(INPUT_FILE, sep="\t")
    print(f"   Samples: {len(df)}")

    print(f"\nü§ñ Model: {MODEL_NAME}")
    print(f"   Strategy: 2-stage (Rules + GPT for all)")
    print(f"   Target: STA=0.88+, SIM=0.93+, FL=0.93+ ‚Üí J=0.76+")

    print("\nüöÄ Processing...\n")

    tqdm.pandas(desc="üéØ Detoxifying")
    df["tat_detox1"] = df["tat_toxic"].progress_apply(hybrid_detox)

    print("\nüõ° Validation...")
    df["tat_detox1"] = df["tat_detox1"].fillna(df["tat_toxic"])

    empty_mask = df["tat_detox1"].isna() | (df["tat_detox1"].str.strip() == "")
    if empty_mask.any():
        print(f"   Empty: {empty_mask.sum()}")
        df.loc[empty_mask, "tat_detox1"] = df.loc[empty_mask, "tat_toxic"]

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    changed = (df["tat_toxic"] != df["tat_detox1"]).sum()

    length_diffs = []
    for idx in range(len(df)):
        orig = df.iloc[idx]["tat_toxic"]
        detox = df.iloc[idx]["tat_detox1"]
        if len(orig) > 0:
            diff = abs(len(detox) - len(orig)) / len(orig)
            length_diffs.append(diff)

    avg_diff = sum(length_diffs) / len(length_diffs) * 100 if length_diffs else 0

    print(f"\nüìä Statistics:")
    print(f"   Total: {len(df)}")
    print(f"   Changed: {changed} ({changed/len(df)*100:.1f}%)")
    print(f"   Avg length Œî: {avg_diff:.1f}%")
    print(f"   Expected SIM: ~{100-avg_diff:.0f}%")

    print(f"\nüì¶ Saving: {OUTPUT_FILE}")
    df[["ID", "tat_toxic", "tat_detox1"]].to_csv(OUTPUT_FILE, sep="\t", index=False)

    print("\n" + "="*70)
    print("‚úÖ IMPROVED SUBMISSION!")
    print("="*70)

    # –ü—Ä–∏–º–µ—Ä—ã
    print("\nüìã Examples (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ):\n")
    shown = 0
    for idx in range(len(df)):
        orig = df.iloc[idx]["tat_toxic"]
        detox = df.iloc[idx]["tat_detox1"]

        if orig != detox and shown < 15:
            diff = abs(len(detox) - len(orig)) / len(orig) * 100 if len(orig) > 0 else 0
            print(f"[{idx}] Œî{diff:.0f}%")
            print(f"üî¥ {orig[:85]}")
            print(f"üü¢ {detox[:85]}\n")
            shown += 1

    print(f"\nüí∞ Tokens:")
    print(f"   API calls: {total_api_calls}")
    print(f"   Input: {total_input_tokens:,}")
    print(f"   Output: {total_output_tokens:,}")

    cost = (total_input_tokens / 1_000_000) * 2.5 + (total_output_tokens / 1_000_000) * 10
    print(f"   Cost: ${cost:.2f}")

    print(f"\nüéØ Expected:")
    print(f"   STA: 0.88+ | SIM: 0.93+ | FL: 0.93+")
    print(f"   J score: 0.76+ ‚Üí –¶–µ–ª—å 0.7 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!")

    print(f"\nüìä –ó–∞–ø—É—Å—Ç–∏ –æ—Ü–µ–Ω–∫—É: python evaluate_j_score.py")


if __name__ == "__main__":
    main()
